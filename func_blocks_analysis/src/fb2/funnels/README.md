# Funnel Features Extractor

Скрипт для автоматического добавления фич по функциональным блокам в датасет с событиями пользователей мобильного приложения.

## Описание

Скрипт анализирует JSON файл с описанием функциональных блоков (воронок) и добавляет в датасет дополнительные колонки, которые содержат агрегированную информацию о взаимодействии пользователя с каждым функциональным блоком в рамках сессии.

## Создаваемые колонки

Для каждого функционального блока создается 4 колонки:

| Колонка | Описание |
|---------|----------|
| `{prefix}_count` | Общее количество действий из блока в рамках сессии |
| `{prefix}_max_step` | Максимальный шаг (step), достигнутый в сессии для этого блока |
| `{prefix}_success_count` | Количество успешных действий (из массива `success_actions`) |
| `{prefix}_review_count` | Количество review действий (из массива `success_review`) |

**Важно:** Значения всех этих колонок одинаковы для всех строк в рамках одной `global_session_id`.

## Префиксы функциональных блоков

| Название блока | Префикс | Примеры колонок |
|----------------|---------|-----------------|
| Создание заявки | `request` | `request_count`, `request_max_step` |
| Просмотр и управление заявками | `req_manage` | `req_manage_count`, `req_manage_max_step` |
| Профиль | `profile` | `profile_count`, `profile_max_step` |
| Навигация | `nav` | `nav_count`, `nav_max_step` |
| Уведомления | `notif` | `notif_count`, `notif_max_step` |
| Опросы и собрания собственников | `poll_oss` | `poll_oss_count`, `poll_oss_max_step` |
| Баллы и поощрения | `rewards` | `rewards_count`, `rewards_max_step` |
| Мой дом | `my_home` | `my_home_count`, `my_home_max_step` |
| Услуги партнеров | `partners` | `partners_count`, `partners_max_step` |
| Управление транспортом | `transport` | `transport_count`, `transport_max_step` |
| Просмотр объявлений | `ann_view` | `ann_view_count`, `ann_view_max_step` |
| Умные решения | `smart` | `smart_count`, `smart_max_step` |
| Техподдержка | `support` | `support_count`, `support_max_step` |
| Гостевой доступ | `guest` | `guest_count`, `guest_max_step` |
| Городские сервисы | `city_serv` | `city_serv_count`, `city_serv_max_step` |
| Создание адреса | `address` | `address_count`, `address_max_step` |
| Создание объявления | `ann_create` | `ann_create_count`, `ann_create_max_step` |

**Всего создается 68 колонок** (17 блоков × 4 колонки).

## Использование

### Базовый пример

```python
from funnel_features_extractor import FunnelFeaturesExtractor
import pandas as pd

# Инициализация
json_path = 'categorized_combinations_with_funnels.json'
extractor = FunnelFeaturesExtractor(json_path)

# Загрузка данных
df = pd.read_csv('events_dataset.csv')

# Применение преобразования
df_transformed = extractor.transform(df)

# Сохранение результата
df_transformed.to_csv('events_with_features.csv', index=False)
```

### Просмотр информации о блоках

```python
# Получить информацию о всех блоках и их префиксах
blocks_info = extractor.get_block_info()
print(blocks_info)
```

## Требования к входным данным

### Датасет событий

Датасет должен содержать следующие обязательные колонки:

- `global_session_id` - уникальный идентификатор сессии
- `Экран` - название экрана
- `Функционал` - название функционала
- `Действие` - описание действия

### JSON файл с функциональными блоками

JSON файл должен содержать структуру:

```json
{
  "blocks": [
    {
      "name": "Название блока",
      "groups": [
        {
          "screen": "Экран",
          "functional": "Функционал",
          "regular_actions": [...],
          "success_actions": [...],
          "success_review": [...],
          ...
        }
      ]
    }
  ]
}
```

## Логика работы

1. **Загрузка конфигурации** - Скрипт читает JSON файл и создает справочники для быстрого поиска действий.

2. **Создание колонок** - Для каждого блока создаются 4 колонки с нулевыми значениями.

3. **Обработка сессий** - Для каждой уникальной `global_session_id`:
   - Анализируются все события в сессии
   - Определяется принадлежность каждого действия к функциональному блоку
   - Подсчитываются метрики:
     - Количество действий из блока
     - Максимальный достигнутый `step`
     - Количество успешных действий
     - Количество review действий

4. **Запись результатов** - Вычисленные метрики записываются во все строки сессии (значения одинаковы для всех строк одной сессии).

## Примеры значений

### Пример 1: Сессия с созданием заявки

```
global_session_id | Экран         | Действие                    | request_count | request_max_step
1                 | Еще           | Тап на кнопку 'Заявки'     | 3            | 2
1                 | Новая заявка  | Открытие экрана            | 3            | 2
1                 | Новая заявка  | Тап на кнопку 'Создать'    | 3            | 2
```

### Пример 2: Сессия без взаимодействия с блоком

```
global_session_id | Экран      | Действие           | request_count | request_max_step
2                 | Профиль    | Открытие экрана    | 0            | -1
2                 | Профиль    | Редактирование     | 0            | -1
```

## Производительность

- Обработка ~1.8 млн строк: ~2-5 минут (зависит от количества уникальных сессий)
- Память: зависит от размера датасета, примерно в 1.5-2 раза больше исходного размера
- Прогресс выводится каждые 10,000 обработанных сессий

## Структура проекта

```
.
├── funnel_features_extractor.py  # Основной класс
├── demo_usage.py                 # Демонстрационный пример
└── README.md                     # Эта документация
```

## Заметки

1. **Значение -1 для max_step** означает, что пользователь не взаимодействовал с данным блоком в сессии.

2. **Все значения одинаковы в рамках сессии** - это сделано специально для удобства дальнейшего анализа и построения моделей машинного обучения.

3. **Блоки независимы** - одно и то же событие может относиться к разным блокам (например, переход может быть частью разных воронок).

## Автор

Скрипт создан для анализа поведения пользователей в мобильном приложении по управлению МКД.
